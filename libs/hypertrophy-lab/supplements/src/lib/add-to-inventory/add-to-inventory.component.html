<div class="flex flex-col gap-2">
  <div class="flex items-center justify-between">
    <p
      tabindex="0"
      class="text-xl font-semibold text-white"
      (click)="onClose()"
      (keypress.enter)="onClose()"
    >
      Add to Inventory
    </p>
    <lib-icon-button
      class="text-text-3"
      [icon]="'xmark-solid'"
      (click)="onClose()"
    ></lib-icon-button>
  </div>
  <div class="flex justify-center">
    <div class="flex gap-1 p-1 rounded-lg justify-center bg-bg w-fit">
      <button
        class="h-7 px-3 flex items-center gap-1 text-xs text-gray-text rounded-md"
        [ngClass]="{ 'text-secondary bg-surface-2': mode() === 'add-existing' }"
        (click)="mode.set('add-existing')"
      >
        <lib-icon [icon]="'download-half-circle-liner'" [iconSize]="20"></lib-icon>
        Add Existing
      </button>
      <button
        class="h-7 px-3 flex items-center gap-1 text-xs text-gray-text rounded-md"
        [ngClass]="{ 'text-secondary bg-surface-2': mode() === 'create' }"
        (click)="mode.set('create')"
      >
        <lib-icon [icon]="'plus-solid'" [iconSize]="20"></lib-icon>
        Create New
      </button>
    </div>
  </div>
</div>

<lib-divider></lib-divider>

<!-- @if (selectedGroup()) { -->
@if (selectedGroup()) {
  <div class="flex items-center gap-2 text-secondary font-medium mb-2">
    <lib-icon [iconSize]="24" class="text-secondary" [icon]="'bullseye-liner'"></lib-icon>
    <span>{{ selectedCatalog()?.name ?? '' }}</span>
    <span class="text-gray-text text-xs">(Per supplement settings)</span>
  </div>
}

@if (!selectedGroup()) {
  <p class="text-sm text-gray-text">
    Choose the supplements you wish to add to your inventory, then select each to adjust
    settings.
    <br />
    Settings will appear here.
  </p>
}

@if (selectedGroup()) {
  <form [formGroup]="form" class="flex flex-col gap-3">
    <div formArrayName="items">
      <div [formGroup]="selectedGroup()!" class="flex flex-col gap-3">
        <div class="flex items-center justify-between gap-4">
          <lib-single-select
            size="sm"
            appearance="minimal"
            label="What's this for?"
            [options]="purposeOptions"
            placeholder="e.g Medical Treatment"
            formControlName="purpose"
          ></lib-single-select>
          <lib-single-select
            size="sm"
            appearance="minimal"
            label="Severity"
            [options]="severityOptions"
            placeholder="e.g Low"
            formControlName="severity"
          ></lib-single-select>
        </div>
        <div class="flex items-center justify-between gap-4">
          <lib-input
            size="sm"
            type="number"
            label="Remaining Stock"
            formControlName="quantityUnits"
            placeholder="Left at home"
          ></lib-input>
          <lib-single-select
            size="sm"
            appearance="minimal"
            label="Reorder Threshold"
            [options]="unitOptions()"
            placeholder="e.g 7 units"
            formControlName="lowStockThresholdUnits"
          ></lib-single-select>
        </div>
        <div
          class="flex items-center gap-4 mb-1"
          [formGroup]="selectedGroup()?.controls?.settings!"
        >
          <div class="flex-1">
            <lib-slide-toggle
              formControlName="intakeRemindersEnabled"
              label="Intake Reminders"
            ></lib-slide-toggle>
          </div>
          <div class="flex-1">
            <lib-slide-toggle
              formControlName="lowStockAlertsEnabled"
              label="Low Stock Alerts"
            ></lib-slide-toggle>
          </div>
        </div>
      </div>
    </div>
  </form>
}

<div class="flex flex-col gap-2">
  <p class="text-lg font-medium text-white">Select Supplements:</p>
  @if (supplementData.hasValue()) {
    <lib-multi-select
      placeholder="Choose supplements"
      [listItemRenderComponent]="existingSuppComponent"
      [items]="options() ?? []"
      [formControl]="existingItemsDropdown"
    ></lib-multi-select>
  } @else if (supplementData.isLoading()) {
    <lib-bouncing-loader></lib-bouncing-loader>
  }

  @if (selectedSupplementsData().length) {
    <hl-added-supplements-overview
      class="mt-1"
      (supplementSelected)="onSupplementOverviewSelect($event)"
      (stockChanged)="onStockChanged($event)"
      [data]="selectedSupplementsData()"
    ></hl-added-supplements-overview>
  }
</div>

<div class="flex justify-center gap-3">
  <lib-button appearance="outline" (click)="onClose()">Discard</lib-button>
  <lib-button (click)="onSubmit()" theme="gradient-primary" [disabled]="!selectedGroup()">
    <lib-icon
      left
      [icon]="'check-circle-broken-liner'"
      [iconSize]="20"
      class="text-white"
    ></lib-icon>
    <p class="text-white">Save</p>
  </lib-button>
</div>

<!-- <div class="px-2">
    <p class="mb-3">Image</p>
    @if (previewUrl()) {
      <img
        class="h-40 w-full object-contain object-top rounded-lg"
        [src]="previewUrl()"
        alt="Supplement Image"
      />
    } @else {
      <div class="h-40 w-full rounded-lg bg-gray-background p-4 flex">
        <div
          class="flex-1 rounded-md flex items-center justify-center hover:bg-gray-200 hover:cursor-pointer transition-all duration-150"
        >
          <input
            type="file"
            accept="image/*"
            (change)="onFileInput($event)"
            #fileInput
            hidden
          />
          <button
            type="button"
            class="btn flex items-center gap-4"
            (click)="fileInput.click()"
          >
            Upload image
            <lib-icon [iconSize]="48" [icon]="'apple-whole-solid'"></lib-icon>
          </button>
        </div>
      </div>
    }
  </div> -->
